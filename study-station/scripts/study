#!/usr/bin/env zsh
# Conmigo Terminal - AI-powered learning companion
# Usage: study <command> [options]

set -e

# Configuration
STUDY_DIR="${HOME}/devvyn-meta-project/study-station"
SESSION_DIR="${STUDY_DIR}/sessions"
TOPIC_DIR="${STUDY_DIR}/topics"
PROGRESS_DIR="${STUDY_DIR}/progress"
TEMPLATE_DIR="${STUDY_DIR}/templates"
ARTIFACT_DIR="${STUDY_DIR}/artifacts"
CONFIG="${STUDY_DIR}/config.yaml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Timestamp
timestamp() {
    date +"%Y%m%d%H%M%S"
}

iso_timestamp() {
    date -u +"%Y-%m-%dT%H:%M:%SZ"
}

# Display banner
banner() {
    echo "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo "${PURPLE}â•‘${NC}  ${CYAN}Conmigo Terminal${NC} - Learning Companion ${PURPLE}â•‘${NC}"
    echo "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Help message
show_help() {
    banner
    echo "Usage: study <command> [options]"
    echo ""
    echo "${CYAN}Commands:${NC}"
    echo "  ${GREEN}start <topic>${NC}        Start a new study session"
    echo "  ${GREEN}ask <question>${NC}       Ask a question (Socratic mode)"
    echo "  ${GREEN}practice <topic>${NC}     Start practice exercises"
    echo "  ${GREEN}review${NC}               Review your progress"
    echo "  ${GREEN}status${NC}               Show current session status"
    echo "  ${GREEN}list${NC}                 List all topics and sessions"
    echo "  ${GREEN}export [session]${NC}     Export session to browser"
    echo "  ${GREEN}hint [level]${NC}         Request a hint (1-4)"
    echo "  ${GREEN}mastery <topic>${NC}      Check mastery level"
    echo ""
    echo "${CYAN}Learning Modes:${NC}"
    echo "  ${YELLOW}explore${NC}  - Open-ended exploration"
    echo "  ${YELLOW}practice${NC} - Structured exercises"
    echo "  ${YELLOW}review${NC}   - Reinforce concepts"
    echo "  ${YELLOW}debug${NC}    - Debug code with guidance"
    echo "  ${YELLOW}build${NC}    - Build a project"
    echo ""
    echo "${CYAN}Examples:${NC}"
    echo "  study start 'rust-ownership'"
    echo "  study ask 'how does borrowing work?'"
    echo "  study practice python-async"
    echo "  study hint 2"
    echo ""
}

# Start a new session
start_session() {
    local topic="$1"
    local mode="${2:-explore}"

    if [[ -z "$topic" ]]; then
        echo "${RED}Error: Topic required${NC}"
        echo "Usage: study start <topic> [mode]"
        exit 1
    fi

    local session_id="$(timestamp)-${topic}"
    local session_file="${SESSION_DIR}/${session_id}.md"
    local topic_dir="${TOPIC_DIR}/${topic}"

    mkdir -p "$topic_dir"
    mkdir -p "${PROGRESS_DIR}/${topic}"

    # Create session file
    cat > "$session_file" <<EOF
# Study Session: ${topic}

**Started:** $(iso_timestamp)
**Mode:** ${mode}
**Session ID:** ${session_id}

---

## Learning Objectives

<!-- What do you want to learn in this session? -->

-

## Session Notes

<!-- Your notes, questions, and discoveries -->

## AI Guidance

<!-- Questions asked and guidance received -->

## Key Insights

<!-- Important takeaways from this session -->

## Next Steps

<!-- What to explore next -->

---

## Progress Log

EOF

    # Update active session tracker
    echo "$session_id" > "${STUDY_DIR}/.active-session"
    echo "${topic}" > "${STUDY_DIR}/.active-topic"

    banner
    echo "${GREEN}âœ“${NC} Started new ${YELLOW}${mode}${NC} session: ${CYAN}${topic}${NC}"
    echo ""
    echo "Session file: ${session_file}"
    echo ""
    echo "${PURPLE}Ready to learn!${NC} Open the session file in your editor."
    echo ""
    echo "Quick start:"
    echo "  â€¢ ${CYAN}study ask <question>${NC} - Ask a question"
    echo "  â€¢ ${CYAN}study hint${NC} - Get a hint"
    echo "  â€¢ ${CYAN}study status${NC} - Check progress"
    echo ""
}

# Ask a question
ask_question() {
    local question="$*"

    if [[ -z "$question" ]]; then
        echo "${RED}Error: Question required${NC}"
        echo "Usage: study ask <question>"
        exit 1
    fi

    # Check for active session
    if [[ ! -f "${STUDY_DIR}/.active-session" ]]; then
        echo "${YELLOW}âš ${NC}  No active session. Start one with: ${CYAN}study start <topic>${NC}"
        exit 1
    fi

    local session_id=$(cat "${STUDY_DIR}/.active-session")
    local session_file="${SESSION_DIR}/${session_id}.md"

    # Append question to session
    echo "" >> "$session_file"
    echo "### Question ($(date '+%H:%M:%S'))" >> "$session_file"
    echo "" >> "$session_file"
    echo "> ${question}" >> "$session_file"
    echo "" >> "$session_file"

    banner
    echo "${CYAN}Question logged:${NC} ${question}"
    echo ""
    echo "${PURPLE}ğŸ¤” Instead of answering directly, let me guide you...${NC}"
    echo ""
    echo "Claude Code will now help you discover the answer through questions."
    echo "Open the session file: ${session_file}"
    echo ""
    echo "${YELLOW}ğŸ’¡ Tip:${NC} Use Claude Code to explore this question interactively!"
    echo ""
}

# Show session status
show_status() {
    banner

    if [[ ! -f "${STUDY_DIR}/.active-session" ]]; then
        echo "${YELLOW}No active session${NC}"
        echo ""
        echo "Start a session: ${CYAN}study start <topic>${NC}"
        exit 0
    fi

    local session_id=$(cat "${STUDY_DIR}/.active-session")
    local topic=$(cat "${STUDY_DIR}/.active-topic")
    local session_file="${SESSION_DIR}/${session_id}.md"

    echo "${GREEN}Active Session${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "Topic:    ${CYAN}${topic}${NC}"
    echo "Session:  ${session_id}"
    echo "File:     ${session_file}"
    echo ""

    # Count lines/questions
    local lines=$(wc -l < "$session_file")
    local questions=$(rg -c "^### Question" "$session_file" 2>/dev/null || echo "0")

    echo "Lines:     ${lines}"
    echo "Questions: ${questions}"
    echo ""
}

# List topics and sessions
list_sessions() {
    banner
    echo "${CYAN}Recent Sessions${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    if [[ ! -d "$SESSION_DIR" ]] || [[ -z "$(ls -A $SESSION_DIR 2>/dev/null)" ]]; then
        echo "No sessions yet. Start one with: ${CYAN}study start <topic>${NC}"
        exit 0
    fi

    fd -t f "\.md$" "$SESSION_DIR" -x basename {} .md | sort -r | head -10
    echo ""
}

# Export session to browser
export_session() {
    local session_id="$1"

    if [[ -z "$session_id" ]]; then
        if [[ -f "${STUDY_DIR}/.active-session" ]]; then
            session_id=$(cat "${STUDY_DIR}/.active-session")
        else
            echo "${RED}Error: No active session${NC}"
            exit 1
        fi
    fi

    local session_file="${SESSION_DIR}/${session_id}.md"

    if [[ ! -f "$session_file" ]]; then
        echo "${RED}Error: Session not found${NC}"
        exit 1
    fi

    local output_file="${HOME}/Desktop/$(timestamp)-study-${session_id}.md"
    cp "$session_file" "$output_file"

    # Route to browser if script exists
    if [[ -x "${HOME}/devvyn-meta-project/scripts/markdown-to-browser.sh" ]]; then
        "${HOME}/devvyn-meta-project/scripts/markdown-to-browser.sh" "$output_file"
        echo "${GREEN}âœ“${NC} Exported to browser"
    else
        echo "${GREEN}âœ“${NC} Exported to: ${output_file}"
    fi
}

# Request hint
request_hint() {
    local level="${1:-1}"

    banner
    echo "${YELLOW}ğŸ’¡ Hint Request (Level ${level})${NC}"
    echo ""

    case $level in
        1)
            echo "Level 1: ${CYAN}Nudge${NC} - A subtle pointer"
            echo "Ask Claude Code to give you a gentle nudge in the right direction."
            ;;
        2)
            echo "Level 2: ${CYAN}Clarify${NC} - Concept clarification"
            echo "Ask Claude Code to clarify the underlying concept."
            ;;
        3)
            echo "Level 3: ${CYAN}Example${NC} - Similar example"
            echo "Ask Claude Code for a similar example or analogy."
            ;;
        4)
            echo "Level 4: ${CYAN}Walkthrough${NC} - Step-by-step guidance"
            echo "Ask Claude Code for step-by-step guidance (last resort!)."
            ;;
        *)
            echo "${RED}Invalid hint level. Use 1-4.${NC}"
            exit 1
            ;;
    esac
    echo ""
}

# Check mastery level
check_mastery() {
    local topic="$1"

    if [[ -z "$topic" ]]; then
        echo "${RED}Error: Topic required${NC}"
        echo "Usage: study mastery <topic>"
        exit 1
    fi

    local progress_file="${PROGRESS_DIR}/${topic}/mastery.yaml"

    banner
    echo "${CYAN}Mastery Level: ${topic}${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    if [[ -f "$progress_file" ]]; then
        cat "$progress_file"
    else
        echo "No mastery data yet for this topic."
        echo ""
        echo "Complete some practice sessions to build mastery!"
    fi
    echo ""
}

# Main command dispatcher
main() {
    case "${1:-help}" in
        start)
            shift
            start_session "$@"
            ;;
        ask)
            shift
            ask_question "$@"
            ;;
        practice)
            shift
            start_session "$1" "practice"
            ;;
        review)
            shift
            start_session "review-$(date +%Y%m%d)" "review"
            ;;
        status)
            show_status
            ;;
        list)
            list_sessions
            ;;
        export)
            shift
            export_session "$@"
            ;;
        hint)
            shift
            request_hint "$@"
            ;;
        mastery)
            shift
            check_mastery "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "${RED}Unknown command: $1${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
